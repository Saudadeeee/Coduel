<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>MVP Online Judge – Edit Problem</title>
  <style>
    :root { color-scheme: light; }
    body {
      margin:0;
      font-family:system-ui, sans-serif;
      background:#f4f1ea;
      color:#2f3b46;
      min-height:100vh;
    }
    header {
      background:#2f3b46;
      color:#f4f1ea;
      padding:18px 28px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      flex-wrap:wrap;
      gap:12px;
    }
    header h1 { margin:0; font-size:20px; }
    header a {
      color:#f4f1ea;
      text-decoration:none;
      font-weight:600;
      padding:8px 14px;
      border:1px solid rgba(244,241,234,0.4);
      border-radius:999px;
    }
    main {
      max-width:1000px;
      margin:30px auto;
      background:#fff;
      border-radius:14px;
      padding:28px;
      box-shadow:0 16px 32px rgba(47,59,70,0.15);
      display:flex;
      flex-direction:column;
      gap:24px;
    }
    h2 { margin:0; font-size:18px; }
    label {
      display:block;
      font-weight:600;
      margin-bottom:6px;
    }
    select, input[type="text"], input[type="number"], textarea {
      width:100%;
      padding:10px 12px;
      border-radius:8px;
      border:1px solid rgba(47,59,70,0.2);
      background:#fdfbf7;
      font-family:inherit;
      font-size:14px;
      color:inherit;
      transition:border-color 0.15s ease, box-shadow 0.15s ease;
    }
    textarea { min-height:140px; resize:vertical; line-height:1.45; }
    textarea.short { min-height:90px; }
    input:focus, select:focus, textarea:focus {
      outline:none;
      border-color:#2f3b46;
      box-shadow:0 0 0 2px rgba(47,59,70,0.12);
      background:#fff;
    }
    .grid {
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap:18px;
    }
    .section {
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .tests {
      display:flex;
      flex-direction:column;
      gap:16px;
    }
    .test-item {
      border-radius:12px;
      border:1px solid rgba(47,59,70,0.18);
      padding:18px;
      background:#f9f6ef;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .test-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
    }
    .test-header strong { font-size:15px; }
    .test-header button {
      background:none;
      border:none;
      color:#c0392b;
      font-weight:600;
      cursor:pointer;
    }
    .actions {
      display:flex;
      flex-wrap:wrap;
      gap:14px;
      justify-content:flex-end;
    }
    button.primary, button.secondary, button.danger {
      border:none;
      border-radius:999px;
      padding:12px 24px;
      font-size:15px;
      font-weight:600;
      cursor:pointer;
      transition:transform 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }
    button.primary {
      background:#2f3b46;
      color:#f4f1ea;
      box-shadow:0 12px 22px rgba(47,59,70,0.20);
    }
    button.primary:hover {
      transform:translateY(-1px);
      box-shadow:0 16px 26px rgba(47,59,70,0.25);
    }
    button.secondary {
      background:#fff;
      color:#2f3b46;
      border:1px solid rgba(47,59,70,0.3);
    }
    button.danger {
      background:#c0392b;
      color:#fff;
      box-shadow:0 12px 22px rgba(192,57,43,0.20);
    }
    button.danger:hover { background:#a93226; }
    .message {
      padding:14px 18px;
      border-radius:10px;
      font-size:14px;
      display:none;
    }
    .message.success {
      background:rgba(39,174,96,0.18);
      border:1px solid rgba(39,174,96,0.45);
      color:#1f7a4d;
    }
    .message.error {
      background:rgba(192,57,43,0.18);
      border:1px solid rgba(192,57,43,0.45);
      color:#7a241b;
    }
    .problem-controls {
      display:flex;
      gap:12px;
      align-items:center;
      flex-wrap:wrap;
    }
    .problem-controls select {
      min-width:240px;
    }
    .muted {
      font-size:13px;
      color:rgba(47,59,70,0.7);
    }
    @media (max-width:680px) {
      main { margin:18px; padding:22px; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Chỉnh sửa problem</h1>
    <nav>
      <a href="/problem">← Về trang luyện tập</a>
      <a href="/problem-add">+ Thêm problem</a>
    </nav>
  </header>
  <main>
    <section class="section">
      <h2>Chọn problem</h2>
      <div class="problem-controls">
        <select id="problem-select"></select>
        <button class="secondary" id="refresh-list">Reload</button>
        <span class="muted" id="problem-meta"></span>
      </div>
    </section>

    <div id="message" class="message"></div>

    <section class="section">
      <div class="grid">
        <div>
          <label for="title">Title</label>
          <input type="text" id="title" placeholder="Problem title">
        </div>
        <div>
          <label for="difficulty">Difficulty</label>
          <select id="difficulty">
            <option value="fast">Fast</option>
            <option value="easy">Easy</option>
            <option value="medium">Medium</option>
            <option value="hard">Hard</option>
          </select>
        </div>
        <div>
          <label for="tags">Tags (comma separated)</label>
          <input type="text" id="tags" placeholder="Ví dụ: math, implementation">
        </div>
      </div>
      <div class="grid">
        <div>
          <label for="time-limit">Time limit (ms)</label>
          <input type="number" id="time-limit" min="1" placeholder="Ví dụ: 2000">
        </div>
        <div>
          <label for="memory-limit">Memory limit (KB)</label>
          <input type="number" id="memory-limit" min="1" placeholder="Ví dụ: 262144">
        </div>
      </div>
    </section>

    <section class="section">
      <label for="description">Description (optional, markdown)</label>
      <textarea id="description" placeholder="Mô tả chung..."></textarea>
      <label for="statement">Statement (markdown)</label>
      <textarea id="statement" placeholder="Toàn bộ đề markdown"></textarea>
    </section>

    <section class="section">
      <h2>Sample IO</h2>
      <div class="grid">
        <div>
          <label for="sample-input">Sample input</label>
          <textarea id="sample-input" class="short" placeholder="Sample input"></textarea>
        </div>
        <div>
          <label for="sample-output">Sample output</label>
          <textarea id="sample-output" class="short" placeholder="Sample output"></textarea>
        </div>
      </div>
    </section>

    <section class="tests">
      <div class="test-header">
        <h2>Test cases</h2>
        <button class="secondary" id="add-test">+ Thêm test</button>
      </div>
      <div id="tests"></div>
    </section>

    <div class="actions">
      <button class="danger" id="delete-problem">Xóa problem</button>
      <button class="primary" id="save-problem">Lưu thay đổi</button>
    </div>
  </main>

  <template id="test-template">
    <div class="test-item">
      <div class="test-header">
        <strong></strong>
        <button type="button" class="remove">Xóa</button>
      </div>
      <label>Input</label>
      <textarea class="test-input" placeholder="Input cho test này"></textarea>
      <label>Output</label>
      <textarea class="test-output" placeholder="Output mong đợi"></textarea>
      <label>Visibility</label>
      <select class="test-visibility">
        <option value="hidden">Hidden (judge only)</option>
        <option value="public">Public (hiển thị như sample)</option>
      </select>
    </div>
  </template>

  <script>
    const api = "http://localhost:8000";
    const selectEl = document.getElementById("problem-select");
    const refreshBtn = document.getElementById("refresh-list");
    const messageBox = document.getElementById("message");
    const problemMeta = document.getElementById("problem-meta");
    const titleInput = document.getElementById("title");
    const difficultySelect = document.getElementById("difficulty");
    const tagsInput = document.getElementById("tags");
    const timeInput = document.getElementById("time-limit");
    const memoryInput = document.getElementById("memory-limit");
    const descriptionInput = document.getElementById("description");
    const statementInput = document.getElementById("statement");
    const sampleInInput = document.getElementById("sample-input");
    const sampleOutInput = document.getElementById("sample-output");
    const testsWrap = document.getElementById("tests");
    const template = document.getElementById("test-template");
    const addTestBtn = document.getElementById("add-test");
    const saveBtn = document.getElementById("save-problem");
    const deleteBtn = document.getElementById("delete-problem");

    let problemsCache = [];
    let currentProblemId = "";

    function showMessage(type, text) {
      messageBox.className = `message ${type}`;
      messageBox.textContent = text;
      messageBox.style.display = "block";
    }

    function clearMessage() {
      messageBox.style.display = "none";
    }

    function refreshTitles() {
      [...testsWrap.children].forEach((node, idx) => {
        const title = node.querySelector("strong");
        if (title) title.textContent = `Test case #${idx + 1}`;
      });
    }

    function addTest(input = "", output = "", visibility = "hidden") {
      const clone = template.content.cloneNode(true);
      const item = clone.querySelector(".test-item");
      item.querySelector(".test-input").value = input;
      item.querySelector(".test-output").value = output;
      const visSelect = item.querySelector(".test-visibility");
      visSelect.value = visibility === "public" ? "public" : "hidden";
      item.querySelector(".remove").addEventListener("click", () => {
        item.remove();
        refreshTitles();
      });
      testsWrap.appendChild(item);
      refreshTitles();
    }

    function resetForm() {
      titleInput.value = "";
      difficultySelect.value = "easy";
      tagsInput.value = "";
      timeInput.value = "";
      memoryInput.value = "";
      descriptionInput.value = "";
      statementInput.value = "";
      sampleInInput.value = "";
      sampleOutInput.value = "";
      testsWrap.innerHTML = "";
      problemMeta.textContent = "";
    }

    async function loadProblems(autoLoad = true) {
      clearMessage();
      try {
        const res = await fetch(`${api}/problems`);
        if (!res.ok) throw new Error(res.statusText);
        const data = await res.json();
        problemsCache = Array.isArray(data.problems) ? data.problems : [];
      } catch (err) {
        console.error(err);
        problemsCache = [];
        showMessage("error", "Không thể tải danh sách problem.");
      }

      selectEl.innerHTML = "";
      if (!problemsCache.length) {
        const option = document.createElement("option");
        option.value = "";
        option.textContent = "No problems available";
        selectEl.appendChild(option);
        selectEl.disabled = true;
        currentProblemId = "";
        resetForm();
        return;
      }
      selectEl.disabled = false;
      problemsCache.forEach((item) => {
        const option = document.createElement("option");
        option.value = item.problem_id;
        const numberLabel = typeof item.number === "number" ? `${String(item.number).padStart(3, "0")} · ` : "";
        const diffLabel = item.difficulty || "unknown";
        option.textContent = `${numberLabel}${item.title || item.problem_id} (${diffLabel})`;
        selectEl.appendChild(option);
      });

      if (!currentProblemId || !problemsCache.some(p => p.problem_id === currentProblemId)) {
        currentProblemId = problemsCache[0].problem_id;
      }
      selectEl.value = currentProblemId;
      if (autoLoad && currentProblemId) {
        await loadProblemDetail(currentProblemId);
      }
    }

    async function loadProblemDetail(problemId) {
      if (!problemId) {
        resetForm();
        return;
      }
      clearMessage();
      try {
        const res = await fetch(`${api}/problem/${encodeURIComponent(problemId)}`);
        if (!res.ok) throw new Error(res.statusText);
        const data = await res.json();
        currentProblemId = problemId;
        fillForm(data);
      } catch (err) {
        console.error(err);
        showMessage("error", "Không thể tải thông tin problem.");
      }
    }

    function fillForm(data) {
      titleInput.value = data.title || "";
      difficultySelect.value = data.difficulty || "easy";
      tagsInput.value = Array.isArray(data.tags) ? data.tags.join(", ") : "";
      if (data.time_limit_ms) timeInput.value = data.time_limit_ms;
      else timeInput.value = "";
      if (data.memory_limit_kb) memoryInput.value = data.memory_limit_kb;
      else memoryInput.value = "";
      descriptionInput.value = data.description || "";
      statementInput.value = data.statement || "";
      if (Array.isArray(data.samples) && data.samples.length) {
        sampleInInput.value = data.samples[0].input || "";
        sampleOutInput.value = data.samples[0].output || "";
      } else {
        sampleInInput.value = "";
        sampleOutInput.value = "";
      }
      testsWrap.innerHTML = "";
      if (Array.isArray(data.tests) && data.tests.length) {
        data.tests.forEach((test) => {
          addTest(test.input || "", test.output || "", test.visibility || "hidden");
        });
      } else {
        addTest();
      }
      refreshTitles();

      const pieces = [];
      if (data.number) pieces.push(`Problem #${data.number}`);
      if (data.tests_summary) {
        pieces.push(`${data.tests_summary.total ?? 0} tests (${data.tests_summary.public ?? 0} public)`);
      }
      if (data.created_at) {
        const dt = new Date(Number(data.created_at) * 1000);
        if (!isNaN(dt.valueOf())) {
          pieces.push(`Created: ${dt.toLocaleString()}`);
        }
      }
      problemMeta.textContent = pieces.join(" · ");
    }

    function collectPayload() {
      const tests = [...testsWrap.querySelectorAll(".test-item")].map(item => {
        const input = item.querySelector(".test-input").value;
        const output = item.querySelector(".test-output").value;
        const visibility = item.querySelector(".test-visibility").value;
        return { input, output, visibility };
      });

      const tags = tagsInput.value.split(",").map(t => t.trim()).filter(Boolean);

      return {
        problem_id: currentProblemId,
        title: titleInput.value.trim(),
        description: descriptionInput.value.trim(),
        statement: statementInput.value,
        sample_input: sampleInInput.value,
        sample_output: sampleOutInput.value,
        difficulty: difficultySelect.value,
        time_limit_ms: timeInput.value ? Number(timeInput.value) : null,
        memory_limit_kb: memoryInput.value ? Number(memoryInput.value) : null,
        tags,
        tests
      };
    }

    addTestBtn.addEventListener("click", () => {
      addTest();
      clearMessage();
    });

    selectEl.addEventListener("change", async () => {
      currentProblemId = selectEl.value;
      if (currentProblemId) {
        await loadProblemDetail(currentProblemId);
      } else {
        resetForm();
      }
    });

    refreshBtn.addEventListener("click", () => loadProblems(true));

    saveBtn.addEventListener("click", async () => {
      if (!currentProblemId) {
        showMessage("error", "Hãy chọn problem để lưu.");
        return;
      }
      const payload = collectPayload();
      if (!payload.title || !payload.sample_input || !payload.sample_output) {
        showMessage("error", "Vui lòng điền đầy đủ thông tin cơ bản.");
        return;
      }
      if (!payload.tests.length) {
        showMessage("error", "Cần ít nhất một test case.");
        return;
      }
      const invalidTest = payload.tests.find(tc => !tc.input.trim() || !tc.output.trim());
      if (invalidTest) {
        showMessage("error", "Mỗi test cần input và output.");
        return;
      }
      clearMessage();
      saveBtn.disabled = true;
      saveBtn.textContent = "Đang lưu...";
      try {
        const res = await fetch(`${api}/problem-edit`, {
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || data.message || res.statusText);
        showMessage("success", "Lưu thành công.");
        await loadProblems(false);
        if (currentProblemId) {
          await loadProblemDetail(currentProblemId);
        }
      } catch (err) {
        console.error(err);
        showMessage("error", err.message || "Không thể lưu problem.");
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = "Lưu thay đổi";
      }
    });

    deleteBtn.addEventListener("click", async () => {
      if (!currentProblemId) {
        showMessage("error", "Chưa chọn problem để xóa.");
        return;
      }
      if (!confirm("Bạn có chắc muốn xóa problem này? Hành động không thể hoàn tác.")) {
        return;
      }
      clearMessage();
      deleteBtn.disabled = true;
      deleteBtn.textContent = "Đang xóa...";
      try {
        const res = await fetch(`${api}/problem-edit`, {
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body: JSON.stringify({ problem_id: currentProblemId, delete: true })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || data.message || res.statusText);
        showMessage("success", "Đã xóa problem.");
        currentProblemId = "";
        resetForm();
        await loadProblems(true);
      } catch (err) {
        console.error(err);
        showMessage("error", err.message || "Không thể xóa problem.");
      } finally {
        deleteBtn.disabled = false;
        deleteBtn.textContent = "Xóa problem";
      }
    });

    loadProblems(true);
  </script>
</body>
</html>
