<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>MVP Online Judge – Add Problem</title>
  <style>
    :root { color-scheme: light; }
    body {
      margin:0;
      font-family:system-ui, sans-serif;
      background:#f4f1ea;
      color:#2f3b46;
      min-height:100vh;
    }
    header {
      background:#2f3b46;
      color:#f4f1ea;
      padding:18px 28px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    header h1 { margin:0; font-size:20px; }
    header a {
      color:#f4f1ea;
      text-decoration:none;
      font-weight:600;
      padding:8px 14px;
      border:1px solid rgba(244,241,234,0.4);
      border-radius:999px;
    }
    main {
      max-width:900px;
      margin:30px auto;
      background:#fff;
      border-radius:14px;
      padding:28px;
      box-shadow:0 16px 32px rgba(47,59,70,0.15);
      display:flex;
      flex-direction:column;
      gap:22px;
    }
    h2 { margin:0; font-size:18px; }
    label {
      display:block;
      font-weight:600;
      margin-bottom:6px;
    }
    input[type="text"],
    select,
    textarea {
      width:100%;
      padding:10px 12px;
      border-radius:8px;
      border:1px solid rgba(47,59,70,0.2);
      background:#fdfbf7;
      font-family:inherit;
      font-size:14px;
      color:inherit;
      transition:border-color 0.15s ease, box-shadow 0.15s ease;
    }
    textarea { min-height:120px; resize:vertical; line-height:1.45; }
    input:focus, select:focus, textarea:focus {
      outline:none;
      border-color:#2f3b46;
      box-shadow:0 0 0 2px rgba(47,59,70,0.12);
      background:#fff;
    }
    .grid {
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap:18px;
    }
    .tests {
      display:flex;
      flex-direction:column;
      gap:16px;
    }
    .test-item {
      border-radius:12px;
      border:1px solid rgba(47,59,70,0.18);
      padding:18px;
      background:#f9f6ef;
    }
    .test-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:12px;
    }
    .test-header button {
      background:none;
      border:none;
      color:#c0392b;
      font-weight:600;
      cursor:pointer;
    }
    button.primary {
      align-self:flex-end;
      background:#2f3b46;
      color:#f4f1ea;
      border:none;
      border-radius:999px;
      padding:12px 24px;
      font-size:15px;
      font-weight:600;
      cursor:pointer;
      box-shadow:0 12px 22px rgba(47,59,70,0.20);
      transition:transform 0.15s ease, box-shadow 0.15s ease;
    }
    button.primary:hover {
      transform:translateY(-1px);
      box-shadow:0 16px 26px rgba(47,59,70,0.25);
    }
    button.outline {
      background:#fff;
      color:#2f3b46;
      border-radius:999px;
      border:1px solid rgba(47,59,70,0.3);
      padding:8px 16px;
      font-weight:600;
      cursor:pointer;
    }
    .message {
      padding:14px 18px;
      border-radius:10px;
      font-size:14px;
      display:none;
    }
    .message.success {
      background:rgba(39,174,96,0.18);
      border:1px solid rgba(39,174,96,0.45);
      color:#1f7a4d;
    }
    .message.error {
      background:rgba(192,57,43,0.18);
      border:1px solid rgba(192,57,43,0.45);
      color:#7a241b;
    }
    @media (max-width:640px) {
      main { margin:18px; padding:22px; }
      header { flex-direction:column; gap:10px; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Thêm problem mới</h1>
    <div style="display:flex; gap:12px; flex-wrap:wrap;">
      <a href="/dashboard">Dashboard</a>
      <a href="/problem">Workspace</a>
      <a href="/problem-edit">Chỉnh sửa problem</a>
    </div>
  </header>
  <main>
    <section>
      <h2>Thông tin chung</h2>
      <p>Điền thông tin để mọi người có thêm problem luyện tập. Số thứ tự sẽ tự động tăng theo danh sách hiện có.</p>
    </section>
    <div class="grid">
      <div>
        <label for="title">Title</label>
        <input type="text" id="title" placeholder="Ví dụ: Sum Three Numbers">
      </div>
      <div>
        <label for="difficulty">Difficulty</label>
        <select id="difficulty">
          <option value="fast">Fast</option>
          <option value="easy">Easy</option>
          <option value="medium">Medium</option>
          <option value="hard">Hard</option>
        </select>
      </div>
    </div>
    <div>
      <label for="description">Description (markdown)</label>
      <textarea id="description" placeholder="Mô tả bài toán, input/output, constraints..."></textarea>
    </div>
    <div class="grid">
      <div>
        <label for="sample-input">Sample input</label>
        <textarea id="sample-input" placeholder="Ví dụ: 1 2 3"></textarea>
      </div>
      <div>
        <label for="sample-output">Sample output</label>
        <textarea id="sample-output" placeholder="Ví dụ: 6"></textarea>
      </div>
    </div>
    <div class="grid">
      <div>
        <label for="time-limit">Time limit (ms)</label>
        <input type="number" id="time-limit" min="1" placeholder="Ví dụ: 2000">
      </div>
      <div>
        <label for="memory-limit">Memory limit (KB)</label>
        <input type="number" id="memory-limit" min="1" placeholder="Ví dụ: 262144">
      </div>
      <div>
        <label for="tags">Tags (comma separated)</label>
        <input type="text" id="tags" placeholder="Ví dụ: math, implementation">
      </div>
    </div>
    <section class="tests">
      <div class="test-header">
        <h2>Test cases</h2>
        <button class="outline" id="add-test">+ Thêm test</button>
      </div>
      <div id="tests"></div>
    </section>
    <div id="message" class="message"></div>
    <button class="primary" id="submit">Gửi problem</button>
  </main>

  <template id="test-template">
    <div class="test-item">
      <div class="test-header">
        <strong></strong>
        <button type="button" class="remove">Xóa</button>
      </div>
      <label>Input</label>
      <textarea class="test-input" placeholder="Input cho test này"></textarea>
      <label style="margin-top:12px;">Output</label>
      <textarea class="test-output" placeholder="Output mong đợi"></textarea>
      <label style="margin-top:12px;">Visibility</label>
      <select class="test-visibility">
        <option value="hidden">Hidden (judge only)</option>
        <option value="public">Public</option>
      </select>
    </div>
  </template>

  <script>
    const api = "http://localhost:8000";
    const testsWrap = document.getElementById("tests");
    const template = document.getElementById("test-template");
    const message = document.getElementById("message");
    const submitBtn = document.getElementById("submit");

    function refreshTitles() {
      [...testsWrap.children].forEach((item, index) => {
        item.querySelector("strong").textContent = `Test case #${index + 1}`;
      });
    }

    function addTest(input = "", output = "", visibility = "hidden") {
      const clone = template.content.cloneNode(true);
      const item = clone.querySelector(".test-item");
      item.querySelector(".test-input").value = input;
      item.querySelector(".test-output").value = output;
      const visibilitySelect = item.querySelector(".test-visibility");
      if (visibilitySelect) visibilitySelect.value = visibility;
      item.querySelector(".remove").addEventListener("click", () => {
        item.remove();
        refreshTitles();
      });
      testsWrap.appendChild(clone);
      refreshTitles();
    }

    function showMessage(kind, text) {
      message.className = `message ${kind}`;
      message.textContent = text;
      message.style.display = "block";
    }

    document.getElementById("add-test").addEventListener("click", () => {
      addTest();
      message.style.display = "none";
    });

    submitBtn.addEventListener("click", async () => {
      message.style.display = "none";
      const title = document.getElementById("title").value.trim();
      const description = document.getElementById("description").value.trim();
      const sampleInput = document.getElementById("sample-input").value;
      const sampleOutput = document.getElementById("sample-output").value;
      const difficulty = document.getElementById("difficulty").value;
      const timeLimitRaw = document.getElementById("time-limit").value.trim();
      const memoryLimitRaw = document.getElementById("memory-limit").value.trim();
      const tagsRaw = document.getElementById("tags").value;

      const tests = [...testsWrap.querySelectorAll(".test-item")].map(item => {
        const inputValue = item.querySelector(".test-input").value;
        const outputValue = item.querySelector(".test-output").value;
        const visibilityValue = item.querySelector(".test-visibility").value;
        return {
          input: inputValue,
          output: outputValue,
          visibility: visibilityValue
        };
      });

      const payload = {
        title,
        description,
        sample_input: sampleInput,
        sample_output: sampleOutput,
        difficulty,
        tests,
        time_limit_ms: null,
        memory_limit_kb: null,
        tags: tagsRaw.split(",").map(t => t.trim()).filter(Boolean)
      };

      if (!payload.title || !payload.description || !payload.sample_input || !payload.sample_output) {
        showMessage("error", "Vui lòng điền đầy đủ thông tin.");
        return;
      }
      if (!payload.tests.length) {
        showMessage("error", "Cần ít nhất một test case.");
        return;
      }
      const emptyTest = payload.tests.find(tc => !tc.input.trim() || !tc.output.trim());
      if (emptyTest) {
        showMessage("error", "Mỗi test cần input và output.");
        return;
      }

      if (timeLimitRaw) {
        const parsed = Number(timeLimitRaw);
        if (!Number.isFinite(parsed) || parsed <= 0) {
          showMessage("error", "Time limit phải là số dương.");
          return;
        }
        payload.time_limit_ms = Math.round(parsed);
      }

      if (memoryLimitRaw) {
        const parsed = Number(memoryLimitRaw);
        if (!Number.isFinite(parsed) || parsed <= 0) {
          showMessage("error", "Memory limit phải là số dương.");
          return;
        }
        payload.memory_limit_kb = Math.round(parsed);
      }

      submitBtn.disabled = true;
      submitBtn.textContent = "Đang gửi...";

      try {
        const res = await fetch(`${api}/problem-add`, {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || data.message || res.statusText);
        showMessage("success", `Tạo thành công! problem_id: ${data.problem_id} (number ${data.number})`);
        document.getElementById("title").value = "";
        document.getElementById("description").value = "";
        document.getElementById("sample-input").value = "";
        document.getElementById("sample-output").value = "";
        document.getElementById("difficulty").value = "fast";
        document.getElementById("time-limit").value = "";
        document.getElementById("memory-limit").value = "";
        document.getElementById("tags").value = "";
        testsWrap.innerHTML = "";
        addTest();
      } catch (err) {
        showMessage("error", err.message || "Không thể tạo problem.");
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = "Gửi problem";
      }
    });

    addTest();
  </script>
</body>
</html>
