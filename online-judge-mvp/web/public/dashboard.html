<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>MVP Online Judge – Dashboard</title>
  <style>
    :root { color-scheme: light; }
    body {
      margin:0;
      font-family:system-ui, sans-serif;
      background:#f4f1ea;
      color:#2f3b46;
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }
    header {
      background:#2f3b46;
      color:#f4f1ea;
      padding:18px 28px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      flex-wrap:wrap;
      gap:12px;
    }
    header h1 { margin:0; font-size:22px; }
    nav {
      display:flex;
      gap:12px;
      flex-wrap:wrap;
    }
    nav a {
      color:#f4f1ea;
      text-decoration:none;
      font-weight:600;
      padding:8px 14px;
      border:1px solid rgba(244,241,234,0.4);
      border-radius:999px;
      background:rgba(244,241,234,0.12);
    }
    main {
      flex:1;
      max-width:1100px;
      margin:30px auto;
      width:95%;
      display:flex;
      flex-direction:column;
      gap:24px;
    }
    .filters {
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:center;
    }
    .filters button {
      border:none;
      border-radius:999px;
      padding:8px 16px;
      font-size:14px;
      font-weight:600;
      cursor:pointer;
      background:#fff;
      color:#2f3b46;
      border:1px solid rgba(47,59,70,0.2);
      transition:background 0.15s ease, transform 0.15s ease;
    }
    .filters button.active {
      background:#2f3b46;
      color:#f4f1ea;
      border-color:#2f3b46;
      box-shadow:0 10px 20px rgba(47,59,70,0.18);
    }
    .filters button:hover { transform:translateY(-1px); }
    .list {
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap:20px;
    }
    .card {
      background:#ffffff;
      border-radius:14px;
      border:1px solid rgba(47,59,70,0.15);
      padding:20px;
      display:flex;
      flex-direction:column;
      gap:12px;
      box-shadow:0 12px 24px rgba(47,59,70,0.12);
    }
    .card header {
      background:none;
      color:inherit;
      padding:0;
      justify-content:flex-start;
      gap:10px;
    }
    .card header h2 {
      margin:0;
      font-size:18px;
    }
    .meta {
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      font-size:12px;
      color:rgba(47,59,70,0.7);
    }
    .tag {
      background:rgba(47,59,70,0.08);
      padding:4px 8px;
      border-radius:8px;
      font-weight:600;
      letter-spacing:0.04em;
      text-transform:uppercase;
      font-size:11px;
    }
    .difficulty {
      border-radius:8px;
      padding:4px 8px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.06em;
      font-size:11px;
    }
    .difficulty.fast { background:#fde68a; color:#b45309; }
    .difficulty.easy { background:#bbf7d0; color:#166534; }
    .difficulty.medium { background:#bfdbfe; color:#1d4ed8; }
    .difficulty.hard { background:#fecdd3; color:#9f1239; }
    .status {
      font-size:13px;
      font-weight:600;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .status.completed { color:#1f7a4d; }
    .status.in-progress { color:#c27c2b; }
    .status.new { color:#5b6470; }
    .actions {
      display:flex;
      gap:10px;
      margin-top:auto;
    }
    .actions a {
      flex:1;
      text-align:center;
      padding:10px 14px;
      border-radius:999px;
      font-weight:600;
      text-decoration:none;
      transition:transform 0.15s ease, box-shadow 0.15s ease;
    }
    .actions a.primary {
      background:#2f3b46;
      color:#f4f1ea;
      box-shadow:0 10px 20px rgba(47,59,70,0.18);
    }
    .actions a.secondary {
      background:#fff;
      color:#2f3b46;
      border:1px solid rgba(47,59,70,0.25);
    }
    .actions a:hover { transform:translateY(-1px); }
    .empty {
      padding:40px;
      text-align:center;
      border:1px dashed rgba(47,59,70,0.2);
      border-radius:12px;
      color:rgba(47,59,70,0.6);
      font-size:15px;
    }
    .loader {
      padding:60px 0;
      text-align:center;
      font-size:16px;
      color:rgba(47,59,70,0.7);
    }
  </style>
</head>
<body>
  <header>
    <h1>Online Judge Dashboard</h1>
    <nav>
      <a href="/problem">Workspace</a>
      <a href="/problem-add">Add Problem</a>
      <a href="/problem-edit">Edit Problem</a>
    </nav>
  </header>
  <main>
    <section class="filters">
      <button data-filter="all" class="active">All</button>
      <button data-filter="completed">Completed</button>
      <button data-filter="in-progress">In Progress</button>
      <button data-filter="new">Not Started</button>
    </section>
    <section id="content">
      <div class="loader" id="loader">Loading problems…</div>
    </section>
  </main>

  <script>
    const api = "http://localhost:8000";
    const content = document.getElementById("content");
    const loader = document.getElementById("loader");
    const filterButtons = document.querySelectorAll(".filters button");

    const STATUS_KEY = "oj-problem-status";
    let currentProblems = [];
    let currentFilter = "all";

    function loadStatuses() {
      try {
        return JSON.parse(localStorage.getItem(STATUS_KEY) || "{}");
      } catch {
        return {};
      }
    }

    function getStatus(problemId) {
      const statuses = loadStatuses();
      return statuses[problemId] || "new";
    }

    function buildCard(problem) {
      const status = getStatus(problem.problem_id);
      const card = document.createElement("article");
      card.className = "card";
      card.dataset.status = status;
      card.dataset.problemId = problem.problem_id;

      const header = document.createElement("header");
      const h2 = document.createElement("h2");
      h2.textContent = problem.title || problem.problem_id;
      header.appendChild(h2);
      card.appendChild(header);

      const meta = document.createElement("div");
      meta.className = "meta";
      if (problem.number) {
        const num = document.createElement("span");
        num.textContent = `#${String(problem.number).padStart(3, "0")}`;
        meta.appendChild(num);
      }
      if (problem.time_limit_ms) {
        const time = document.createElement("span");
        time.textContent = `Time: ${formatTime(problem.time_limit_ms)}`;
        meta.appendChild(time);
      }
      if (problem.memory_limit_kb) {
        const mem = document.createElement("span");
        mem.textContent = `Memory: ${formatMemory(problem.memory_limit_kb)}`;
        meta.appendChild(mem);
      }
      const tests = document.createElement("span");
      tests.textContent = `${problem.tests || 0} tests`;
      meta.appendChild(tests);
      card.appendChild(meta);

      const topRow = document.createElement("div");
      topRow.style.display = "flex";
      topRow.style.gap = "10px";
      topRow.style.flexWrap = "wrap";
      const diff = document.createElement("span");
      diff.className = `difficulty ${problem.difficulty || "unknown"}`;
      diff.textContent = problem.difficulty || "unknown";
      topRow.appendChild(diff);

      const statusEl = document.createElement("div");
      statusEl.className = `status ${status}`;
      statusEl.textContent = statusLabel(status);
      topRow.appendChild(statusEl);
      card.appendChild(topRow);

      if (Array.isArray(problem.tags) && problem.tags.length) {
        const tagsRow = document.createElement("div");
        tagsRow.style.display = "flex";
        tagsRow.style.flexWrap = "wrap";
        tagsRow.style.gap = "6px";
        problem.tags.forEach(tag => {
          const span = document.createElement("span");
          span.className = "tag";
          span.textContent = tag;
          tagsRow.appendChild(span);
        });
        card.appendChild(tagsRow);
      }

      const actions = document.createElement("div");
      actions.className = "actions";
      const solveLink = document.createElement("a");
      solveLink.className = "primary";
      solveLink.href = `/problem?pid=${encodeURIComponent(problem.problem_id)}`;
      solveLink.textContent = "Solve";
      const editLink = document.createElement("a");
      editLink.className = "secondary";
      editLink.href = `/problem-edit#${encodeURIComponent(problem.problem_id)}`;
      editLink.textContent = "Edit";
      actions.appendChild(solveLink);
      actions.appendChild(editLink);
      card.appendChild(actions);
      return card;
    }

    function statusLabel(status) {
      if (status === "completed") return "Completed";
      if (status === "in-progress") return "In Progress";
      return "Not Started";
    }

    function formatTime(ms) {
      const num = Number(ms);
      if (!Number.isFinite(num) || num <= 0) return "";
      if (num >= 1000) {
        const seconds = num / 1000;
        return `${(seconds >= 10 ? seconds.toFixed(1) : seconds.toFixed(2)).replace(/\\.0+$/, "").replace(/\\.([1-9])0$/, ".$1")} s`;
      }
      return `${Math.round(num)} ms`;
    }

    function formatMemory(kb) {
      const num = Number(kb);
      if (!Number.isFinite(num) || num <= 0) return "";
      if (num >= 1024 * 5) {
        const mb = num / 1024;
        return `${mb.toFixed(mb >= 10 ? 1 : 2).replace(/\\.0+$/, "").replace(/\\.([1-9])0$/, ".$1")} MB`;
      }
      return `${num} KB`;
    }

    function renderList(problems) {
      currentProblems = problems;
      loader?.remove();
      content.innerHTML = "";
      if (!problems.length) {
        const empty = document.createElement("div");
        empty.className = "empty";
        empty.textContent = "Không có problem nào trong danh sách.";
        content.appendChild(empty);
        return;
      }
      const grid = document.createElement("div");
      grid.className = "list";
      problems.forEach(problem => grid.appendChild(buildCard(problem)));
      content.appendChild(grid);
      refreshCardStatuses();
      applyFilter(currentFilter);
    }

    async function init() {
      try {
        const res = await fetch(`${api}/problems`);
        if (!res.ok) throw new Error(res.statusText);
        const data = await res.json();
        const problems = Array.isArray(data.problems) ? data.problems : [];
        renderList(problems);
      } catch (err) {
        console.error(err);
        loader.textContent = "Không thể tải danh sách problem.";
      }
    }

    filterButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        filterButtons.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        currentFilter = btn.dataset.filter;
        applyFilter(currentFilter);
      });
    });

    function applyFilter(filter) {
      const cards = content.querySelectorAll(".card");
      cards.forEach(card => {
        const status = card.dataset.status;
        let visible = true;
        if (filter === "completed") visible = status === "completed";
        else if (filter === "in-progress") visible = status === "in-progress";
        else if (filter === "new") visible = status === "new";
        card.style.display = visible ? "flex" : "none";
      });
    }

    function refreshCardStatuses() {
      const statuses = loadStatuses();
      const cards = content.querySelectorAll(".card");
      cards.forEach(card => {
        const id = card.dataset.problemId;
        const status = statuses[id] || "new";
        card.dataset.status = status;
        const statusEl = card.querySelector(".status");
        if (statusEl) {
          statusEl.textContent = statusLabel(status);
          statusEl.className = `status ${status}`;
        }
      });
    }

    window.addEventListener("storage", (event) => {
      if (event.key === STATUS_KEY) {
        refreshCardStatuses();
        applyFilter(currentFilter);
      }
    });

    init();
  </script>
</body>
</html>
