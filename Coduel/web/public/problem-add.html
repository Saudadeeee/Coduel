<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>MVP Online Judge – Add Problem</title>
  <style>
    :root {
      color-scheme: dark;
      --bg-top: #11151c;
      --bg-bottom: #212d40;
      --panel-bg: rgba(17,21,28,0.6);
      --panel-bg-soft: rgba(17,21,28,0.3);
      --border: #364156;
      --border-soft: rgba(54,65,86,0.4);
      --accent: #7d4e57;
      --accent-hover: #915763;
      --text-main: #ffffff;
      --text-dim: #9aa4ba;
      --text-dimmer: rgba(154,164,186,0.6);
      --code-bg: #1a1f29;
      --code-fg: #e8e9f4;
      --success-bg: rgba(39,174,96,0.08);
      --success-border: rgba(39,174,96,0.4);
      --success-text: #85ffa8;
      --error-bg: rgba(192,57,43,0.08);
      --error-border: rgba(192,57,43,0.4);
      --error-text: #ff7a7a;
    }

    * {
      box-sizing:border-box;
      margin:0;
      padding:0;
      -webkit-font-smoothing: antialiased;
    }

    body {
      margin:0;
      font-family:system-ui, sans-serif;
      background:
        radial-gradient(circle at 50% 20%, rgba(125,78,87,0.22) 0%, rgba(33,45,64,0) 60%),
        linear-gradient(to bottom, var(--bg-top) 0%, var(--bg-bottom) 100%);
      color:var(--text-main);
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }

    header {
      background:rgba(17,21,28,0.8);
      color:var(--text-main);
      padding:18px 28px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      border-bottom:1px solid var(--border);
      box-shadow:0 24px 48px rgba(0,0,0,0.7), 0 2px 4px rgba(0,0,0,0.8);
      backdrop-filter: blur(4px);
      position:sticky;
      top:0;
      z-index:10;
    }

    header h1 {
      margin:0;
      font-size:20px;
      font-weight:600;
      letter-spacing:-0.03em;
      color:var(--text-main);
    }

    header a {
      color:var(--text-main);
      text-decoration:none;
      font-weight:600;
      padding:8px 14px;
      border:1px solid rgba(125,78,87,0.4);
      border-radius:999px;
      background:rgba(125,78,87,0.18);
      font-size:13px;
      line-height:1.2rem;
      box-shadow:0 16px 32px rgba(0,0,0,0.7);
      transition:all 0.15s ease;
    }
    header a:hover {
      background:rgba(145,87,99,0.3);
      box-shadow:0 24px 48px rgba(0,0,0,0.8),
                 0 0 12px rgba(125,78,87,0.6);
    }

    main {
      width:100%;
      max-width:900px;
      margin:30px auto;
      background:var(--panel-bg);
      border-radius:16px;
      padding:28px;
      box-shadow:
        0 32px 64px rgba(0,0,0,0.8),
        0 2px 4px rgba(0,0,0,0.8),
        0 0 32px rgba(125,78,87,0.2);
      border:1px solid var(--border);
      display:flex;
      flex-direction:column;
      gap:22px;
    }

    h2 {
      margin:0;
      font-size:18px;
      font-weight:600;
      color:var(--text-main);
      letter-spacing:-0.02em;
    }

    p {
      font-size:14px;
      line-height:1.5;
      color:var(--text-dim);
      margin:8px 0 0;
    }

    label {
      display:block;
      font-weight:600;
      margin-bottom:6px;
      font-size:14px;
      color:var(--text-main);
    }

    input[type="text"],
    input[type="number"],
    select,
    textarea {
      width:100%;
      padding:10px 12px;
      border-radius:8px;
      border:1px solid var(--border);
      background:var(--panel-bg-soft);
      font-family:inherit;
      font-size:14px;
      color:var(--text-main);
      line-height:1.45;
      box-shadow:0 16px 32px rgba(0,0,0,0.6);
      transition:border-color 0.15s ease,
                 box-shadow 0.15s ease,
                 background 0.15s ease;
    }

    textarea {
      min-height:120px;
      resize:vertical;
    }

    input:focus,
    select:focus,
    textarea:focus {
      outline:none;
      border-color:var(--accent);
      box-shadow:
        0 0 0 2px rgba(125,78,87,0.4),
        0 24px 48px rgba(0,0,0,0.8);
      background:#1f2531;
    }

    .grid {
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap:18px;
    }

    /* test cases wrapper */
    .tests {
      display:flex;
      flex-direction:column;
      gap:16px;
    }

    .test-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      flex-wrap:wrap;
      gap:12px;
    }

    .test-header strong {
      font-weight:600;
      color:var(--text-main);
    }

    /* mỗi test item card */
    .test-item {
      border-radius:12px;
      border:1px solid var(--border);
      padding:18px;
      background:var(--panel-bg-soft);
      box-shadow:
        0 20px 40px rgba(0,0,0,0.7),
        0 2px 4px rgba(0,0,0,0.8);
    }

    .test-item .test-header {
      margin-bottom:12px;
    }

    .test-item .remove {
      background:none;
      border:none;
      color:#ff7a7a;
      font-weight:600;
      cursor:pointer;
      font-size:13px;
      line-height:1.2rem;
      padding:4px 0;
      transition:color 0.15s ease;
    }
    .test-item .remove:hover {
      color:#ff9c9c;
    }

    /* buttons */
    button.primary {
      align-self:flex-end;
      background:var(--accent);
      color:#fff;
      border:1px solid var(--accent);
      border-radius:999px;
      padding:12px 24px;
      font-size:15px;
      font-weight:600;
      cursor:pointer;
      box-shadow:
        0 24px 48px rgba(0,0,0,0.7),
        0 2px 4px rgba(0,0,0,0.8),
        0 0 16px rgba(125,78,87,0.6);
      transition:transform 0.15s ease,
                 box-shadow 0.15s ease,
                 background 0.15s ease;
    }

    button.primary:hover {
      transform:translateY(-1px);
      background:var(--accent-hover);
      border-color:var(--accent-hover);
      box-shadow:
        0 32px 64px rgba(0,0,0,0.8),
        0 4px 8px rgba(0,0,0,0.9),
        0 0 20px rgba(145,87,99,0.8);
    }

    button.primary:active {
      transform:translateY(0);
    }

    button.outline {
      background:transparent;
      color:var(--text-main);
      border-radius:999px;
      border:1px solid var(--border);
      padding:8px 16px;
      font-weight:600;
      font-size:13px;
      cursor:pointer;
      box-shadow:0 16px 32px rgba(0,0,0,0.6);
      transition:all 0.15s ease;
    }
    button.outline:hover {
      background:rgba(54,65,86,0.2);
      box-shadow:
        0 24px 48px rgba(0,0,0,0.7),
        0 2px 4px rgba(0,0,0,0.8);
    }

    .message {
      padding:14px 18px;
      border-radius:10px;
      font-size:14px;
      line-height:1.4;
      display:none;
      max-width:100%;
      word-break:break-word;
    }

    .message.success {
      background:var(--success-bg);
      border:1px solid var(--success-border);
      color:var(--success-text);
      box-shadow:0 16px 32px rgba(0,0,0,0.6);
    }

    .message.error {
      background:var(--error-bg);
      border:1px solid var(--error-border);
      color:var(--error-text);
      box-shadow:0 16px 32px rgba(0,0,0,0.6);
    }

    @media (max-width:640px) {
      main {
        margin:18px;
        padding:22px;
      }
      header {
        flex-direction:column;
        gap:10px;
      }
      button.primary {
        width:100%;
        text-align:center;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Add New Problem</h1>
    <div style="display:flex; gap:12px; flex-wrap:wrap;">
      <a href="/dashboard">Dashboard</a>
      <a href="/workspace.html">Workspace</a>
      <a href="/problem-edit">Edit Problem</a>
    </div>
  </header>

  <main>
    <section>
      <h2>General Information</h2>
      <p>Fill in the information to add a problem for practice. The problem number will be automatically incremented based on the current list.</p>
    </section>

    <div class="grid">
      <div>
        <label for="title">Title</label>
        <input type="text" id="title" placeholder="Example: Sum Three Numbers">
      </div>
      <div>
        <label for="difficulty">Difficulty</label>
        <select id="difficulty">
          <option value="fast">Fast</option>
          <option value="easy">Easy</option>
          <option value="medium">Medium</option>
          <option value="hard">Hard</option>
        </select>
      </div>
    </div>

    <div>
      <label for="description">Description (markdown)</label>
      <textarea id="description" placeholder="Problem description, input/output format, constraints..."></textarea>
    </div>

    <div class="grid">
      <div>
        <label for="sample-input">Sample input</label>
        <textarea id="sample-input" placeholder="Example: 1 2 3"></textarea>
      </div>
      <div>
        <label for="sample-output">Sample output</label>
        <textarea id="sample-output" placeholder="Example: 6"></textarea>
      </div>
    </div>

    <div class="grid">
      <div>
        <label for="time-limit">Time limit (ms)</label>
        <input type="number" id="time-limit" min="1" placeholder="Example: 2000">
      </div>
      <div>
        <label for="memory-limit">Memory limit (KB)</label>
        <input type="number" id="memory-limit" min="1" placeholder="Example: 262144">
      </div>
      <div>
        <label for="tags">Tags (comma separated)</label>
        <input type="text" id="tags" placeholder="Example: math, implementation">
      </div>
    </div>

    <section class="tests">
      <div class="test-header">
        <h2>Test cases</h2>
        <button class="outline" id="add-test">+ Add Test</button>
      </div>
      <div id="tests"></div>
    </section>

    <div id="message" class="message"></div>

    <button class="primary" id="submit">Submit Problem</button>
  </main>

  <template id="test-template">
    <div class="test-item">
      <div class="test-header">
        <strong></strong>
        <button type="button" class="remove">Remove</button>
      </div>

      <label>Input</label>
      <textarea class="test-input" placeholder="Input for this test"></textarea>

      <label style="margin-top:12px;">Output</label>
      <textarea class="test-output" placeholder="Expected output"></textarea>

      <label style="margin-top:12px;">Visibility</label>
      <select class="test-visibility">
        <option value="hidden">Hidden (judge only)</option>
        <option value="public">Public</option>
      </select>
    </div>
  </template>

  <script>
    const api = "http://localhost:8000";

    const testsWrap = document.getElementById("tests");
    const template = document.getElementById("test-template");
    const message = document.getElementById("message");
    const submitBtn = document.getElementById("submit");

    function refreshTitles() {
      [...testsWrap.children].forEach((item, index) => {
        item.querySelector("strong").textContent = `Test case #${index + 1}`;
      });
    }

    function addTest(input = "", output = "", visibility = "hidden") {
      const clone = template.content.cloneNode(true);
      const item = clone.querySelector(".test-item");

      item.querySelector(".test-input").value = input;
      item.querySelector(".test-output").value = output;

      const visibilitySelect = item.querySelector(".test-visibility");
      if (visibilitySelect) visibilitySelect.value = visibility;

      item.querySelector(".remove").addEventListener("click", () => {
        item.remove();
        refreshTitles();
      });

      testsWrap.appendChild(clone);
      refreshTitles();
    }

    function showMessage(kind, text) {
      message.className = `message ${kind}`;
      message.textContent = text;
      message.style.display = "block";
    }

    document.getElementById("add-test").addEventListener("click", () => {
      addTest();
      message.style.display = "none";
    });

    submitBtn.addEventListener("click", async () => {
      message.style.display = "none";

      const title = document.getElementById("title").value.trim();
      const description = document.getElementById("description").value.trim();
      const sampleInput = document.getElementById("sample-input").value;
      const sampleOutput = document.getElementById("sample-output").value;
      const difficulty = document.getElementById("difficulty").value;
      const timeLimitRaw = document.getElementById("time-limit").value.trim();
      const memoryLimitRaw = document.getElementById("memory-limit").value.trim();
      const tagsRaw = document.getElementById("tags").value;

      const tests = [...testsWrap.querySelectorAll(".test-item")].map(item => {
        const inputValue = item.querySelector(".test-input").value;
        const outputValue = item.querySelector(".test-output").value;
        const visibilityValue = item.querySelector(".test-visibility").value;
        return {
          input: inputValue,
          output: outputValue,
          visibility: visibilityValue
        };
      });

      const payload = {
        title,
        description,
        sample_input: sampleInput,
        sample_output: sampleOutput,
        difficulty,
        tests,
        time_limit_ms: null,
        memory_limit_kb: null,
        tags: tagsRaw.split(",").map(t => t.trim()).filter(Boolean)
      };

      if (!payload.title || !payload.description || !payload.sample_input || !payload.sample_output) {
        showMessage("error", "Please fill in all required fields.");
        return;
      }

      if (!payload.tests.length) {
        showMessage("error", "At least one test case is required.");
        return;
      }

      const emptyTest = payload.tests.find(tc => !tc.input.trim() || !tc.output.trim());
      if (emptyTest) {
        showMessage("error", "Each test case needs input and output.");
        return;
      }

      if (timeLimitRaw) {
        const parsed = Number(timeLimitRaw);
        if (!Number.isFinite(parsed) || parsed <= 0) {
          showMessage("error", "Time limit must be a positive number.");
          return;
        }
        payload.time_limit_ms = Math.round(parsed);
      }

      if (memoryLimitRaw) {
        const parsed = Number(memoryLimitRaw);
        if (!Number.isFinite(parsed) || parsed <= 0) {
          showMessage("error", "Memory limit must be a positive number.");
          return;
        }
        payload.memory_limit_kb = Math.round(parsed);
      }

      submitBtn.disabled = true;
      submitBtn.textContent = "Submitting...";

      try {
        const res = await fetch(`${api}/problem-add`, {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify(payload)
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || data.message || res.statusText);

        showMessage("success",
          `Successfully created! problem_id: ${data.problem_id} (number ${data.number})`
        );

        // reset form
        document.getElementById("title").value = "";
        document.getElementById("description").value = "";
        document.getElementById("sample-input").value = "";
        document.getElementById("sample-output").value = "";
        document.getElementById("difficulty").value = "fast";
        document.getElementById("time-limit").value = "";
        document.getElementById("memory-limit").value = "";
        document.getElementById("tags").value = "";

        testsWrap.innerHTML = "";
        addTest();

      } catch (err) {
        showMessage("error", err.message || "Unable to create problem.");
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = "Submit Problem";
      }
    });

    addTest();
  </script>
</body>
</html>
